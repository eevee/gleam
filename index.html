<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf8">
    <title>GLEAM visual novel creator</title>
    <link rel="stylesheet" type="text/css" href="editor.css">
    <link rel="stylesheet" type="text/css" href="player.css">
    <script src="gleam-player.js"></script>
    <script src="gleam-editor.js"></script>
</head>
<body>
    <header>
        <h1>GLEAM visual novel creator</h1>
        <div id="gleam-editor-header-metadata">
            <label>Title: <input type="text" id="gleam-editor-meta-title"></label>
            <label>Subtitle (optional): <input type="text" id="gleam-editor-meta-subtitle"></label>
            <button type="button">Export</button>
        </div>
    </header>
    <section class="gleam-editor-panel" id="gleam-editor-player">
        <div class="gleam-editor-panel-body">
        </div>
    </section>
    <section class="gleam-editor-panel" id="gleam-editor-roles">
        <header><h1>Roles</h1></header>
        <div class="gleam-editor-panel-body">
            <ol class="gleam-editor-roles">
            </ol>
        </div>
    </section>
    <section class="gleam-editor-panel" id="gleam-editor-assets">
        <header><h1>Assets</h1></header>
        <div class="gleam-editor-panel-body">
            <ol class="gleam-editor-assets">
            </ol>
        </div>
    </section>
    <section class="gleam-editor-panel" id="gleam-editor-script">
        <header>
            <h1>Script</h1>
            <nav></nav>
        </header>
        <div class="gleam-editor-panel-body">
            <ol class="gleam-editor-beats-list">
            </ol>
            <!-- TODO waterfall view?  see what the state of anything is at any point? -->
        </div>
        <footer>
            <!-- state of selected beat goes here -->
        </footer>
    </section>
    <script>
        // FIXME give a real api for this.  question is, how do i inject into the editor AND the player
        window.addEventListener('load', ev => {
            // FIXME does the editor really take over just from being created?
            let editor = new Gleam.Editor(document.querySelector('.gleam-editor'));
            window._gleam_editor = editor;

            //*
            // TODO i guess this needs some ui
            let json = window.localStorage.getItem('gleam-temp');
            let script;
            if (json) {
                // TODO error handling here, probably
                script = Gleam.MutableScript.from_json(JSON.parse(json));
            }
            else {
                script = new Gleam.MutableScript;
                script.add_role(new Gleam.Stage('stage'));
            }
            editor.load_script(script, new Gleam.NullAssetLibrary);
            return;
            //*/

            // NOTE TO FUTURE GIT SPELUNKERS: sorry this exists only on my filesystem and points to all the old flora vns lol
            let root = 'res/prompt2-itchyitchy-final/';
            let root_url = new URL(root, document.location);
            //root_url = new URL('https://apps.veekun.com/flora-cutscenes/res/prompt2-itchyitchy-final/');
            let library = new Gleam.RemoteAssetLibrary(root_url);
            let xhr = new XMLHttpRequest;
            xhr.addEventListener('load', ev => {
                // FIXME handle errors yadda yadda
                let script = Gleam.MutableScript.from_legacy_json(JSON.parse(xhr.responseText));
                editor.load_script(script, library);
            });
            // XXX lol
            xhr.open('GET', new URL('script.json', root_url));
            xhr.send();
        });
    </script>
</body>
</html>
